= Development Guide
:toc:

== Prerequisites

This project uses https://pixi.sh/[pixi] for dependency management instead of rustup.
Pixi manages both the Rust toolchain and other development dependencies through conda-forge.

=== Installing Pixi

==== Linux & macOS

[source,bash]
----
curl -fsSL https://pixi.sh/install.sh | bash
----

==== Windows

[source,powershell]
----
iwr -useb https://pixi.sh/install.ps1 | iex
----

Alternatively, you can install pixi via conda:

[source,bash]
----
conda install -c conda-forge pixi
----

== Quick Start

Once pixi is installed, you can use the project without any additional setup:

[source,bash]
----
# Build the project
pixi run build

# Run tests
pixi run test

# Run the application
pixi run run

# Check code (without building)
pixi run check

# Format code
pixi run fmt

# Run clippy linter
pixi run clippy
----

Pixi will automatically install Rust and all dependencies the first time you run any command.

== Available Commands

All commands are defined in `pixi.toml` under the `[tasks]` section:

* `pixi run build` - Compile the project
* `pixi run test` - Run all tests
* `pixi run run` - Run the application
* `pixi run check` - Quick syntax check
* `pixi run fmt` - Format code with rustfmt
* `pixi run clippy` - Run the clippy linter with strict warnings

== Direct Cargo Access

You can also use cargo directly through pixi:

[source,bash]
----
pixi run cargo build --release
pixi run cargo test -- --nocapture
pixi run cargo doc --open
----

== Environment Activation

Pixi creates an isolated environment.
You can activate it for direct shell access:

[source,bash]
----
pixi shell
----

This gives you access to `cargo`, `rustc`, and other tools directly.

== Adding Dependencies

To add Rust dependencies, edit `Cargo.toml`:

[source,toml]
----
[dependencies]
my-crate = "1.0"
----

To add system-level dependencies through pixi, edit `pixi.toml` or use:

[source,bash]
----
pixi add <package-name>
----

== Project Structure

----
incus-composer/
├── src/                  # Rust source code
│   ├── main.rs          # Application entry point
│   └── schema.rs        # Schema definitions
├── examples/            # Example configuration files
├── Cargo.toml           # Rust package manifest
├── Cargo.lock           # Locked dependency versions
├── pixi.toml            # Pixi project configuration
├── pixi.lock            # Locked pixi environment (not in git)
└── .pixi/               # Pixi cache directory (not in git)
----

== Why Pixi?

Pixi offers several advantages over rustup:

. *Reproducible Environments*: Exact versions of all dependencies are locked
. *Cross-Platform*: Works consistently across Linux, macOS, and Windows
. *Multi-Language*: Can manage non-Rust dependencies (Python, C libraries, etc.)
. *Fast*: Leverages conda's efficient binary package distribution
. *Isolated*: Each project has its own environment

== Troubleshooting

=== Pixi command not found

After installation, you may need to restart your shell or source the configuration:

[source,bash]
----
source ~/.bashrc  # or ~/.zshrc
----

=== Build fails with missing dependencies

Try cleaning the environment:

[source,bash]
----
pixi clean
pixi run build
----

=== Version conflicts

Ensure you're using a compatible Rust version.
The project specifies the Rust version in `pixi.toml`.

== CI/CD

For continuous integration, install pixi in your CI environment:

[source,yaml]
----
# GitHub Actions example
- name: Install pixi
  run: curl -fsSL https://pixi.sh/install.sh | bash

- name: Build and test
  run: |
    pixi run build
    pixi run test
----

== Contributing

When contributing, please:

. Run `pixi run fmt` to format your code
. Run `pixi run clippy` to check for common mistakes
. Run `pixi run test` to ensure all tests pass
. Do not commit `pixi.lock` or `.pixi/` directory (they're gitignored)
. Do commit changes to `pixi.toml` if you add dependencies

== Resources

* https://pixi.sh/latest/[Pixi Documentation]
* https://doc.rust-lang.org/[Rust Documentation]
* https://linuxcontainers.org/incus/docs/main/[Incus Documentation]
